#!/usr/bin/perl

# AR-INSTALL
# this script sets up a new AR directory

# ---   *   ---   *   ---

BEGIN {

  my $ex=$ENV{'ARPATH'}.'/avtomat/AR.ph';
  my $me=`$ex`;

  print $me;
  if($me=~ m/^ARPATH missing/) {
    exit;

  };

};

# ---   *   ---   *   ---
# deps

  use strict;
  use warnings;

  use lib $ENV{'ARPATH'}.'/lib/';
  use avt;

# ---   *   ---   *   ---

my $root=avt::root($ENV{'ARPATH'});
unshift @ARGV,$root.'/lib/';avt::stlib();

# ---   *   ---   *   ---
# fetch missing deps

{ my @deps=(

    ['help',avt->LYEB.'/help',undef],
    ['ft8',avt->LYEB.'/ft8',undef],
    ['ce',avt->LYEB.'/ce',undef],

  );avt::depchk $root,\@deps;

};

# ---   *   ---   *   ---
# PACKAGE CONFIGS

# ---   *   ---   *   ---
# avtomat

{ my %config=(

  'NAME'  =>  'avtomat',

  );

  $config{'PREB'}=q(
    my $ex=$ENV{'ARPATH'}.'/avtomat/AR.ph';
    my $me=`$ex`;

    print $me;
    if($me=~ m/^ARPATH missing/) {
      exit;

    };

  );avt::strconfig \%config;

};

# ---   *   ---   *   ---
# ce

{ my %config=(

  'NAME'  =>  'ce',
  'SCAN'  =>  '-x keys',

  'BUILD' =>  'x:ce',

  'XCPY'  =>  'wpid',
  'XPRT'  =>  'keyboard.h,clock.h,arstd.h',

  'GENS'  =>  'chartab.h:chartab*,'.
              'keymap.h:[keymap*,genks.pm,%.k]',

  'LIBS'  =>  'X11',

# ---   *   ---   *   ---
# post-build calls for ce

  );$config{'POST'}=q(

    unshift @ARGV,avt::root.'/lib/';
    avt::stlib();

    avt::wrcplboil_pm(
      '/lib/',
      'lycon',
      'IBN-3DILA',

      \&avt::ctopl,['lycon',['ce']]

    );avt::plext(

      '/lib/lycon.pm',
      '/ce/lycon_ext'

    );

  );avt::strconfig \%config;

};

# ---   *   ---   *   ---
# help

{ my %config=(

  'NAME'  =>  'help',
  'XCPY'  =>  'help*,tkmny*',

  );avt::strconfig \%config;

};

# ---   *   ---   *   ---
# ft8

{ my @deps=(

    ['rw-psf',
      avt->GITHUB.'/talamus/rw-psf',
      undef

    ],

  );avt::depchk "$root/ft8",\@deps;

  my %config=(

  'NAME'  =>  'ft8',
  'XCPY'  =>  'ft8*,writepsf*',

# ---   *   ---   *   ---
# post-build calls for ft8

  );$config{'POST'}=q(

    if(!(-e avt::root."/fonts")) {

      avt::ex 'ft8',[
        '-g','8,16,24',

        avt::root."/ft8/lycon",
        avt::root."/fonts"

      ],'';

      avt::ex 'ft8',[
        '-x','8,16,24','lycon',

        avt::root."/fonts/",
        avt::root."/fonts/X11"

      ],'';

    };);avt::strconfig \%config;

};

# ---   *   ---   *   ---
# sin

{ my %config=(

  'NAME'  =>  'sin',
  'BUILD' =>  'ar:sin',

  'GENS'  =>  'shblk.h:[shblk*,%.glsl]',
  'LIBS'  =>  'GL,GLEW,ce',

  );avt::strconfig \%config;

};

# ---   *   ---   *   ---
# chasm

{ my %config=(

  'NAME'  =>  'chasm',

  'BUILD' =>  'ar:chasm',
  'LIBS'  =>  'sin,SDL2,SDL2main',

  );avt::strconfig \%config;

};

# ---   *   ---   *   ---
# install packages

avt::scan();
avt::config();
avt::make();

for my $mod(avt::MODULES) {
  print `$root/$mod/avto`;

};

# ---   *   ---   *   ---
1; # ret
